bplist00Ñ_WebMainResourceÕ	
_WebResourceMIMEType_WebResourceTextEncodingName^WebResourceURL_WebResourceFrameName_WebResourceDataYtext/htmlUUTF-8[about:blankPO®Í<html><head><style></style></head><body>


	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta charset="utf-8">
	<title>æ­å»ºå¾®ä¿¡å°ç¨‹åºæœåŠ¡ - å¼€å‘è€…å®éªŒå®¤ - è…¾è®¯äº‘</title>
	<meta name="keywords" content="">
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2">
	<meta name="format-detection" content="telephone=no">
	<link rel="icon" href="https://www.qcloud.com/favicon.ico" type="image/x-icon">
	<style media="screen">
		 /* è¯´æ˜ï¼šä¸ºäº†æ–¹ä¾¿ç”¨æˆ·å¯ä»¥ç›´æ¥ä¸‹è½½æŸ¥çœ‹ï¼Œæ ·å¼é‡‡ç”¨å†…åµŒçš„æ–¹å¼ä¹¦å†™ */
		body {
			margin: 0;
			padding: 30px;
			background-color: #fff;
			font-size: 14px;
			line-height: 1.5;
			color: #444;
		}
		a {
			color: #2277da;
			text-decoration: none;
			cursor: pointer;
		}
		a:hover {
			text-decoration: underline;
		}

		/* æ•™ç¨‹æ–‡æ¡£ start */
		.lab-edi-doc {
			margin: 0 auto;
			max-width: 960px;
			min-width: 320px;
		}
		.lab-edi-doc :first-child {
			margin-top: 0;
		}
		.lab-edi-doc h1,
		.lab-edi-doc h2,
		.lab-edi-doc h3,
		.lab-edi-doc h4 {
			margin: 30px 0 15px;
			font-weight: normal;
			color: #000;
		}
		.lab-edi-doc h1 {
			font-size: 24px;
		}
		.lab-edi-doc h2 {
			font-size: 18px;
		}
		.lab-edi-doc h3 {
			font-size: 16px;
		}
		.lab-edi-doc h4 {
			font-size: 14px;
			font-weight: bold;
		}
		.lab-edi-doc blockquote {
			margin: 0 0 20px;
			padding: 0 15px;
			color: #888;
			border-left: 4px solid #ddd;
		}
		.lab-edi-doc pre {
			margin: 0 0 10px;
			padding: 10px 15px;
			overflow: auto;
			background-color: #343638;
			border-radius: 2px;
			color: #fff;
			max-height: 600px;
			font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
		}
		.lab-edi-doc code {
			position: relative;
			top: -1px;
			display: inline-block;
			margin: 0 3px;
			padding: 0 3px;
			color: #000;
			vertical-align: middle;
			background-color: #e3e4e5;
			font-size: 14px;
			line-height: 18px;
		}
		.lab-edi-doc pre code {
			background: transparent;
			color: #fff;
		}
		.lab-edi-doc p {
			margin-bottom: 10px;
		}
		.lab-edi-doc ol,
		.lab-edi-doc ul {
			list-style: none;
			margin: 0 0 15px;
			padding: 0;
		}
		.lab-edi-doc ol {
			counter-reset: num;
		}
		.lab-edi-doc ol > li {
			margin-bottom: 3px;
		}
		.lab-edi-doc ol > li:before {
			counter-increment: num;
			content: counter(num)'. ';
		}
		.lab-edi-doc ul > li {
			margin-bottom: 3px;
		}
		.lab-edi-doc ul > li:before {
			content: '';
			display: inline-block;
			vertical-align: middle;
			position: relative;
			top: -1px;
			margin-left: 3px;
			margin-right: 5px;
			width: 4px;
			height: 4px;
			border-radius: 50%;
			background-color: #444;
		}
	</style>

<div class="lab-edi-doc"><h1 id="-">æ­å»ºå¾®ä¿¡å°ç¨‹åºæœåŠ¡</h1>
<h2 id="-">å‡†å¤‡åŸŸåå’Œè¯ä¹¦</h2>
<blockquote>
<p>ä»»åŠ¡æ—¶é—´ï¼š20min ~ 40min</p>
</blockquote>
<p>å°ç¨‹åºåå°æœåŠ¡éœ€è¦é€šè¿‡ HTTPS è®¿é—®ï¼Œåœ¨å®éªŒå¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å‡†å¤‡åŸŸåå’Œ SSL è¯ä¹¦ã€‚</p>
<h3 id="-">åŸŸåæ³¨å†Œ</h3>
<p>å¦‚æœæ‚¨è¿˜æ²¡æœ‰åŸŸåï¼Œå¯ä»¥<a target="_blank" href="https://dnspod.qcloud.com/?fromSource=lab" title="null">åœ¨è…¾è®¯äº‘ä¸Šé€‰è´­</a>ï¼Œè¿‡ç¨‹å¯ä»¥å‚è€ƒä¸‹é¢çš„è§†é¢‘ã€‚</p>
<ul>
<li><em>è§†é¢‘ - åœ¨è…¾è®¯äº‘ä¸Šè´­ä¹°åŸŸå</em></li>
</ul>
<h3 id="-">åŸŸåè§£æ</h3>
<p>åŸŸåè´­ä¹°å®Œæˆå, éœ€è¦å°†åŸŸåè§£æåˆ°å®éªŒäº‘ä¸»æœºä¸Šï¼Œå®éªŒäº‘ä¸»æœºçš„ IP ä¸ºï¼š</p>
<pre><code>&lt;æ‚¨çš„ CVM IP åœ°å€&gt;
</code></pre><p>åœ¨è…¾è®¯äº‘è´­ä¹°çš„åŸŸåï¼Œå¯ä»¥<em>åˆ°æ§åˆ¶å°æ·»åŠ è§£æè®°å½•</em>ï¼Œè¿‡ç¨‹å¯å‚è€ƒä¸‹é¢çš„è§†é¢‘ï¼š</p>
<ul>
<li><em>è§†é¢‘ - å¦‚ä½•åœ¨è…¾è®¯äº‘ä¸Šè§£æåŸŸå</em> </li>
</ul>
<p>åŸŸåè®¾ç½®è§£æåéœ€è¦è¿‡ä¸€æ®µæ—¶é—´æ‰ä¼šç”Ÿæ•ˆï¼Œé€šè¿‡ <code>ping</code> å‘½ä»¤æ£€æŸ¥åŸŸåæ˜¯å¦ç”Ÿæ•ˆ <sup>[<a href="#stage-1-step-2-replace">?</a>]</sup>ï¼Œå¦‚ï¼š</p>
<pre><code>ping www.yourmpdomain.com
</code></pre><p>å¦‚æœ ping å‘½ä»¤è¿”å›çš„ä¿¡æ¯ä¸­å«æœ‰ä½ è®¾ç½®çš„è§£æçš„ IP åœ°å€ï¼Œè¯´æ˜è§£ææˆåŠŸã€‚</p>
<p><a id="stage-1-step-2-replace"></a></p>
<blockquote>
<p>æ³¨æ„æ›¿æ¢ä¸‹é¢å‘½ä»¤ä¸­çš„ <code>www.yourmpdomain.com</code> ä¸ºæ‚¨è‡ªå·±çš„æ³¨å†Œçš„åŸŸå</p>
</blockquote>
<h3 id="-ssl-">ç”³è¯· SSL è¯ä¹¦</h3>
<p>è…¾è®¯äº‘æä¾›äº† SSL è¯ä¹¦çš„<em>å…è´¹ç”³è¯·</em>ï¼Œç”³è¯·æ–¹å¼å¯å‚è€ƒä¸‹é¢è§†é¢‘ï¼š</p>
<ul>
<li><em>è§†é¢‘ - åœ¨è…¾è®¯äº‘ä¸Šç”³è¯· SSL è¯ä¹¦</em></li>
</ul>
<p>ç”³è¯·æäº¤åï¼Œå®¡æ‰¹ç»“æœä¼šä»¥çŸ­ä¿¡çš„å½¢å¼é€šçŸ¥ã€‚å®¡æ‰¹é€šè¿‡åï¼Œå¯ä»¥åˆ° <em>SSL æ§åˆ¶å°</em>ä¸‹è½½æ‚¨çš„è¯ä¹¦æ–‡ä»¶ï¼Œå¯å‚è€ƒä¸‹é¢çš„è§†é¢‘ï¼š</p>
<ul>
<li><em>è§†é¢‘ - åœ¨è…¾è®¯äº‘ä¸Šä¸‹è½½ SSL è¯ä¹¦</em> </li>
</ul>
<h2 id="-">æ­å»ºå°ç¨‹åºå¼€å‘ç¯å¢ƒ</h2>
<blockquote>
<p>ä»»åŠ¡æ—¶é—´ï¼š15min ~ 30min</p>
</blockquote>
<p>åœ¨å¼€å§‹æ­å»ºæˆ‘ä»¬çš„å°ç¨‹åºæœåŠ¡å™¨ä¹‹å‰ï¼Œéœ€è¦å…ˆå®Œæˆå®¢æˆ·ç«¯å°ç¨‹åºå¼€å‘ç¯å¢ƒçš„æ­å»ºã€‚</p>
<h3 id="-">æ³¨å†Œå¼€å‘è€…è´¦å·</h3>
<p>å¦‚æœä½ è¿˜ä¸æ˜¯å°ç¨‹åºå¼€å‘è€…ï¼Œè¯·å…ˆåœ¨å¾®ä¿¡å…¬ä¼—å¹³å°å¹¶æ³¨å†Œï¼š</p>
<pre><code>https://mp.weixin.qq.com
</code></pre><p>å…·ä½“æ³¨å†Œæµç¨‹å¯å‚è€ƒå¦‚ä¸‹è§†é¢‘ï¼š</p>
<ul>
<li><em>è§†é¢‘ - æ³¨å†Œå¼€å‘è€…è´¦å·</em> </li>
</ul>
<p>è‹¥æ‚¨å·²æ³¨å†Œï¼Œè¯·ç‚¹å‡»ä¸‹ä¸€æ­¥ã€‚</p>
<h3 id="-">é…ç½®å°ç¨‹åºæœåŠ¡å™¨ä¿¡æ¯</h3>
<p>ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°åï¼Œä¾æ¬¡è¿›å…¥ <code>è®¾ç½®</code> - <code>å¼€å‘è®¾ç½®</code> - <code>æœåŠ¡å™¨åŸŸå</code> - <code>ä¿®æ”¹</code>ã€‚</p>
<p>æ‰«ç å®Œæˆèº«ä»½æ ¡éªŒåï¼Œrequest åˆæ³•åŸŸåå’Œ socket åˆæ³•åŸŸåå‡å¡«å†™åœ¨ä¸Šä¸€æ­¥å‡†å¤‡å¥½çš„åŸŸååœ°å€ã€‚</p>
<p>é…ç½®å®Œæˆåï¼Œç‚¹å‡» <code>ä¿å­˜å¹¶æäº¤</code>ã€‚æ‚¨å¯ä»¥ç‚¹å‡»å¦‚ä¸‹è§†é¢‘æŸ¥çœ‹å¦‚ä½•è¿›è¡Œé…ç½®ï¼š</p>
<ul>
<li><em>è§†é¢‘ - é…ç½®å°ç¨‹åºæœåŠ¡å™¨ä¿¡æ¯</em> </li>
</ul>
<h3 id="-">è¿è¡Œé…å¥—å°ç¨‹åºä»£ç </h3>
<p>è¦è¿è¡Œæœ¬å®éªŒé…å¥—çš„å°ç¨‹åºä»£ç ï¼Œè¯·ä¸‹è½½ä¸‹åˆ—èµ„æºï¼š</p>
<ul>
<li><a target="_blank" href="https://github.com/tencentyun/lab-rps-client/archive/master.zip" title="null">å®éªŒé…å¥—æºç </a></li>
<li><a target="_blank" href="https://mp.weixin.qq.com/debug/wxadoc/dev/devtools/download.html" title="null">å¾®ä¿¡å°ç¨‹åºå¼€å‘å·¥å…·</a></li>
</ul>
<p>æºç ä¸‹è½½åï¼Œè¯·è§£å‹åˆ°æœ¬åœ°å·¥ä½œç›®å½•ã€‚</p>
<p>å¼€å‘å·¥å…·ä¸‹è½½åï¼Œè¯·å®‰è£…å¹¶å¯åŠ¨ï¼Œç„¶åç”¨å¾®ä¿¡æ‰«ç ç™»å½•ã€‚</p>
<p>ç™»å½•åï¼Œé€‰æ‹© <code>æœ¬åœ°å°ç¨‹åºé¡¹ç›®</code> - <code>æ·»åŠ é¡¹ç›®</code>ï¼Œä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š</p>
<ul>
<li>AppIDï¼šå¡«å†™å°ç¨‹åºçš„ AppIDï¼Œè¯·ç™»å½•<a target="_blank" href="https://mp.weixin.qq.com" title="null">å…¬ä¼—å¹³å°</a>ååœ¨ <code>è®¾ç½®</code> - <code>å¼€å‘è®¾ç½®</code> - <code>å¼€å‘è€… ID</code> ä¸­æŸ¥çœ‹</li>
<li>é¡¹ç›®åç§°ï¼šå¡«å†™ä»»æ„æ‚¨å–œæ¬¢çš„åç§°</li>
<li>é¡¹ç›®ç›®å½•ï¼šé€‰æ‹©åˆšæ‰è§£å‹çš„é…å¥—æºç ç›®å½•ï¼ˆç›®å½•åŒ…å« <code>app.js</code>ï¼‰</li>
</ul>
<p>å¡«å†™å®Œæˆåï¼Œç‚¹å‡» <code>æ·»åŠ é¡¹ç›®</code>ã€‚å…·ä½“æ“ä½œå¯æŸ¥çœ‹å¦‚ä¸‹è§†é¢‘ï¼š</p>
<ul>
<li><em>è§†é¢‘ - è¿è¡Œé…å¥—å°ç¨‹åºä»£ç </em> </li>
</ul>
<h3 id="-">è®¾ç½®å®éªŒåŸŸå</h3>
<p>åœ¨å¼€å‘å·¥å…·çš„ <code>ç¼–è¾‘</code> é¢æ¿ä¸­ï¼Œé€‰ä¸­ <code>app.js</code> è¿›è¡Œç¼–è¾‘ï¼Œéœ€è¦ä¿®æ”¹å°ç¨‹åºé€šä¿¡åŸŸå<sup>[<a href="#stage-2-step-4-domain">?</a>]</sup>ï¼Œè¯·å‚è€ƒä¸‹é¢çš„é…ç½®ï¼š</p>
<pre><code>App({
    config: {
        host: '' // è¿™ä¸ªåœ°æ–¹å¡«å†™ä½ çš„åŸŸå
    },
    onLaunch () {
        console.log('App.onLaunch()');
    }
});
</code></pre><p>å½“ç„¶ï¼Œè¿™æ­¥æ“ä½œä¹Ÿå½•åˆ¶äº†å¯¹åº”çš„è§†é¢‘ï¼š</p>
<ul>
<li><em>è§†é¢‘ - è®¾ç½®å®éªŒåŸŸå</em> </li>
</ul>
<p><a id="stage-2-step-4-domain"></a></p>
<blockquote>
<p>å®éªŒé…å¥—æºç æ‰€ç”¨é€šä¿¡åŸŸåéƒ½ä¼šä½¿ç”¨è¯¥è®¾ç½®ï¼Œä¸ºäº†æ‚¨é¡ºåˆ©è¿›è¡Œå®éªŒï¼Œè¯·æŠŠåŸŸåä¿®æ”¹ä¸ºä¹‹å‰æ­¥éª¤å‡†å¤‡çš„åŸŸå</p>
</blockquote>
<h2 id="-http-">æ­å»º HTTP æœåŠ¡</h2>
<blockquote>
<p>ä»»åŠ¡æ—¶é—´ï¼š15min ~ 30min</p>
</blockquote>
<p>ä¸‹é¢çš„æ­¥éª¤ï¼Œå°†å¸¦å¤§å®¶åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ Node å’Œ Express æ­å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨</p>
<h3 id="-nodejs-npm">å®‰è£… NodeJS å’Œ NPM</h3>
<p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£… NodeJS å’Œ NPM</p>
<pre><code>yum install nodejs npm -y
</code></pre><p>å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æµ‹è¯•å®‰è£…ç»“æœ</p>
<pre><code>node -v
</code></pre><h3 id="-http-server-">ç¼–å†™ HTTP Server æºç </h3>
<h4 id="-">åˆ›å»ºå·¥ä½œç›®å½•</h4>
<p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åœ¨æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•ï¼š</p>
<pre><code>mkdir -p /data/release/weapp
</code></pre><p>è¿›å…¥æ­¤å·¥ä½œç›®å½•</p>
<pre><code>cd /data/release/weapp
</code></pre><h4 id="-package-json">åˆ›å»º package.json</h4>
<p>åœ¨åˆšæ‰åˆ›å»ºçš„å·¥ä½œç›®å½•<em>åˆ›å»º package.json</em>ï¼Œæ·»åŠ æˆ‘ä»¬æœåŠ¡å™¨åŒ…çš„åç§°å’Œç‰ˆæœ¬å·ï¼Œå¯å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ã€‚</p>
<h5 id="-data-release-weapp-package-json">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/package.json</h5>
<pre><code class="lang-json">{
    "name": "weapp",
    "version": "1.0.0"
}
</code></pre>
<p>å®Œæˆåï¼Œä½¿ç”¨ <code>Ctrl + S</code> ä¿å­˜æ–‡ä»¶</p>
<h4 id="-server-">æ·»åŠ  Server æºç </h4>
<p>åœ¨å·¥ä½œç›®å½•<em>åˆ›å»º app.js</em>ï¼Œä½¿ç”¨ Express.js æ¥ç›‘å¬ <code>8765</code> ç«¯å£<sup>[<a href="#stage-3-step-2-8765">?</a>]</sup>ï¼Œå¯å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ã€‚</p>
<h5 id="-data-release-weapp-app-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/app.js</h5>
<pre><code class="lang-js">// å¼•ç”¨ express æ¥æ”¯æŒ HTTP Server çš„å®ç°
const express = require('express');

// åˆ›å»ºä¸€ä¸ª express å®ä¾‹
const app = express();

// å®ç°å”¯ä¸€çš„ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¯¹äºæ‰€æœ‰è¯·æ±‚ï¼Œéƒ½è¾“å‡º "Response from express"
app.use((request, response, next) =&gt; {
    response.write('Response from express');
    response.end();
});

// ç›‘å¬ç«¯å£ï¼Œç­‰å¾…è¿æ¥
const port = 8765;
app.listen(port);

// è¾“å‡ºæœåŠ¡å™¨å¯åŠ¨æ—¥å¿—
console.log(`Server listening at http://127.0.0.1:${port}`);
</code></pre>
<p><a id="stage-3-step-2-8765"></a></p>
<blockquote>
<p>æœ¬å®éªŒä¼šä»¥ 8765 ç«¯å£çš„æ‰“å¼€ä½œä¸ºå®éªŒæ­¥éª¤å®Œæˆçš„ä¾æ®ï¼Œä¸ºäº†åé¢çš„å®éªŒæ­¥éª¤é¡ºåˆ©è¿›è¡Œï¼Œè¯·ä¸è¦ä½¿ç”¨å…¶å®ƒç«¯å£å·</p>
</blockquote>
<h3 id="-http-">è¿è¡Œ HTTP æœåŠ¡</h3>
<h4 id="-pm2">å®‰è£… PM2</h4>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å®‰è£… <sup>[<a href="#stage-3-step-3-PM2">PM2</a>]</sup></p>
<pre><code>npm install pm2 --global
</code></pre><p>PM2 å®‰è£…æ—¶é—´å¯èƒ½ç¨é•¿ï¼Œè¯·è€å¿ƒç­‰å€™ <sup>[<a href="#stage-3-step-3-slow">?</a>]</sup></p>
<h4 id="-express">å®‰è£… Express</h4>
<p>æˆ‘ä»¬çš„æœåŠ¡å™¨æºç é‡Œä½¿ç”¨åˆ°äº† Express æ¨¡å—ï¼Œä¸‹é¢çš„å‘½ä»¤ä½¿ç”¨ NPM æ¥å®‰è£… Express</p>
<pre><code>cd /data/release/weapp
npm install express --save
</code></pre><h4 id="-">å¯åŠ¨æœåŠ¡</h4>
<p>å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ PM2 æ¥å¯åŠ¨ HTTP æœåŠ¡</p>
<pre><code>cd /data/release/weapp
pm2 start app.js
</code></pre><p>ç°åœ¨ï¼Œæ‚¨çš„ HTTP æœåŠ¡å·²ç»åœ¨ <a target="_blank" href="http://&lt;æ‚¨çš„ CVM IP åœ°å€&gt;:8765" title="null">http://&lt;æ‚¨çš„ CVM IP åœ°å€&gt;:8765</a> è¿è¡Œ</p>
<p>è¦æŸ¥çœ‹æœåŠ¡è¾“å‡ºçš„æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<pre><code>pm2 logs
</code></pre><p>å¦‚æœè¦é‡å¯æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<pre><code>pm2 restart app
</code></pre><p><a id="stage-3-step-3-PM2"></a></p>
<blockquote>
<p>æˆ‘ä»¬ä½¿ç”¨ PM2 æ¥è¿›è¡Œ Node è¿›ç¨‹çš„è¿è¡Œã€ç›‘æ§å’Œç®¡ç†</p>
</blockquote>
<p><a id="stage-3-step-3-slow"></a></p>
<blockquote>
<p>NPM ä»“åº“åœ¨å›½å†…è®¿é—®é€Ÿåº¦å¯èƒ½ä¸å¤ªç†æƒ³ï¼Œå¦‚æœå®åœ¨å¤ªæ…¢å¯ä»¥å°è¯•ä½¿ç”¨ CNPM çš„ Registry è¿›è¡Œå®‰è£…ï¼š<code>npm install pm2 -g --registry=https://r.cnpmjs.org/</code></p>
</blockquote>
<h2 id="-https-">æ­å»º HTTPS æœåŠ¡</h2>
<blockquote>
<p>ä»»åŠ¡æ—¶é—´ï¼š15min ~ 30min</p>
</blockquote>
<p>å¾®ä¿¡å°ç¨‹åºè¦æ±‚å’ŒæœåŠ¡å™¨çš„é€šä¿¡éƒ½é€šè¿‡ HTTPS è¿›è¡Œ</p>
<h3 id="-nginx">å®‰è£… Nginx</h3>
<p>åœ¨ CentOS ä¸Šï¼Œå¯ç›´æ¥ä½¿ç”¨ <code>yum</code> æ¥å®‰è£… Nginx</p>
<pre><code>yum install nginx -y
</code></pre><p>å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ <code>nginx</code> å‘½ä»¤å¯åŠ¨ Nginxï¼š</p>
<pre><code>nginx
</code></pre><p>æ­¤æ—¶ï¼Œè®¿é—® <a target="_blank" href="http://&lt;æ‚¨çš„åŸŸå" title="null">http://&lt;æ‚¨çš„åŸŸå&gt;</a> å¯ä»¥çœ‹åˆ° Nginx çš„æµ‹è¯•é¡µé¢ <sup>[<a href="#stage-4-step-1-help">?</a>]</sup></p>
<p><a id="stage-4-step-1-help"></a></p>
<blockquote>
<p>å¦‚æœæ— æ³•è®¿é—®ï¼Œè¯·é‡è¯•ç”¨ <code>nginx -s reload</code> å‘½ä»¤é‡å¯ Nginx</p>
</blockquote>
<h3 id="-https-">é…ç½® HTTPS åå‘ä»£ç†</h3>
<p>å¤–ç½‘ç”¨æˆ·è®¿é—®æœåŠ¡å™¨çš„ Web æœåŠ¡ç”± Nginx æä¾›ï¼ŒNginx éœ€è¦é…ç½®åå‘ä»£ç†æ‰èƒ½ä½¿å¾— Web æœåŠ¡è½¬å‘åˆ°æœ¬åœ°çš„ Node æœåŠ¡ã€‚</p>
<p>å…ˆå°†ä¹‹å‰ä¸‹è½½çš„ SSL è¯ä¹¦(è§£å‹å Nginx ç›®å½•åˆ†åˆ«ä»¥ crt å’Œ key ä½œä¸ºåç¼€çš„æ–‡ä»¶)é€šè¿‡<code>æ‹–åŠ¨åˆ°å·¦ä¾§æ–‡ä»¶æµè§ˆå™¨/etc/nginxç›®å½•</code>çš„æ–¹å¼æ¥ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ä¸Š</p>
<p><em>å¦‚ä½•ä¸Šä¼  SSL è¯ä¹¦åˆ° /etc/nginx ç›®å½•</em> </p>
<p>Nginx é…ç½®ç›®å½•åœ¨ <em>/etc/nginx/conf.d</em>ï¼Œæˆ‘ä»¬åœ¨è¯¥ç›®å½•åˆ›å»º <em>ssl.conf</em></p>
<h5 id="-etc-nginx-conf-d-ssl-conf">ç¤ºä¾‹ä»£ç ï¼š/etc/nginx/conf.d/ssl.conf</h5>
<pre><code class="lang-nginx">server {
        listen 443;
        server_name www.example.com; # æ”¹ä¸ºç»‘å®šè¯ä¹¦çš„åŸŸå
        # ssl é…ç½®
        ssl on;
        ssl_certificate 1_www.example.com_bundle.crt; # æ”¹ä¸ºè‡ªå·±ç”³è¯·å¾—åˆ°çš„ crt æ–‡ä»¶çš„åç§°
        ssl_certificate_key 2_www.example.com.key; # æ”¹ä¸ºè‡ªå·±ç”³è¯·å¾—åˆ°çš„ key æ–‡ä»¶çš„åç§°
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://127.0.0.1:8765;
        }
    }
</code></pre>
<p>æŒ‰ <code>Ctrl + S</code> ä¿å­˜é…ç½®æ–‡ä»¶ï¼Œè®© Nginx é‡æ–°åŠ è½½é…ç½®ä½¿å…¶ç”Ÿæ•ˆï¼š</p>
<pre><code>nginx -s reload
</code></pre><p>åœ¨æµè§ˆå™¨é€šè¿‡ https çš„æ–¹å¼è®¿é—®ä½ è§£æçš„åŸŸåæ¥æµ‹è¯• HTTPS æ˜¯å¦æˆåŠŸå¯åŠ¨</p>
<h3 id="-https-">åœ¨å°ç¨‹åºä¸­æµ‹è¯• HTTPS è®¿é—®</h3>
<p>æ‰“å¼€é…å¥—çš„å°ç¨‹åºï¼Œç‚¹å‡» <code>å®éªŒä¸€ï¼šHTTPS</code>ï¼Œç‚¹å‡» <code>å‘é€è¯·æ±‚</code> æ¥æµ‹è¯•è®¿é—®ç»“æœã€‚</p>
<p>å¦‚æœæœåŠ¡å™¨å“åº”æˆåŠŸï¼Œè¯·ç‚¹å‡»ä¸‹ä¸€æ­¥ã€‚</p>
<h2 id="-">å°ç¨‹åºä¼šè¯</h2>
<blockquote>
<p>ä»»åŠ¡æ—¶é—´ï¼š45min ~ 90min</p>
</blockquote>
<p>å°ç¨‹åºä¸æ”¯æŒ Cookie å­˜å‚¨å’Œè·Ÿè¸ªï¼ŒæœåŠ¡å™¨éœ€è¦è‡ªè¡Œå®ç°ä¼šè¯å±‚</p>
<h3 id="-mongodb">å®‰è£… MongoDB</h3>
<p>ä½¿ç”¨ Yum åœ¨æœºå™¨ä¸Šå®‰è£… <sup>[<a href="#stage-5-step-1-MongoDB">MongoDB</a>]</sup> åŠå…¶å®¢æˆ·ç«¯å‘½ä»¤è¡Œå·¥å…·ï¼š</p>
<pre><code>yum install mongodb-server mongodb -y
</code></pre><p>å®‰è£…ç»“æŸåï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å®‰è£…çš„ç‰ˆæœ¬ï¼š</p>
<pre><code>mongod --version
mongo --version
</code></pre><p><a id="stage-5-step-1-MongoDB"></a></p>
<blockquote>
<p>MongoDB æ˜¯ä¸€æ¬¾ NoSQL æ•°æ®åº“ï¼Œæ”¯æŒ JSON æ ¼å¼çš„ç»“æ„åŒ–æ–‡æ¡£å­˜å‚¨å’ŒæŸ¥è¯¢ï¼Œå¯¹ JavaScript æœ‰ç€å‹å¥½çš„æ”¯æŒ</p>
</blockquote>
<h3 id="-mongodb">å¯åŠ¨ MongoDB</h3>
<p>åˆ›å»ºç›®å½•ï¼Œç”¨äº MongoDB æ•°æ®å’Œæ—¥å¿—å­˜å‚¨ï¼š</p>
<pre><code>mkdir -p /data/mongodb
mkdir -p /data/logs/mongodb
</code></pre><p>åˆ›å»ºåï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å¯åŠ¨ MongoDBï¼š<sup>[<a href="#stage-5-step-2-long-boot">?</a>]</sup></p>
<pre><code>mongod --fork --dbpath /data/mongodb --logpath /data/logs/mongodb/weapp.log
</code></pre><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ <sup>[<a href="#stage-5-step-2-why-27017">?</a>]</sup></p>
<pre><code>netstat -ltp | grep 27017
</code></pre><p><a id="stage-5-step-2-long-boot"></a></p>
<blockquote>
<p>MongoDB é¦–æ¬¡å¯åŠ¨å¯èƒ½ä¼šèŠ±è´¹å¤§æ¦‚ 1min æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
</blockquote>
<p><a id="stage-5-step-2-why-27017"></a></p>
<blockquote>
<p>MongoDB é»˜è®¤ç›‘å¬ 27017 ç«¯å£ç­‰å¾…è¿æ¥ï¼Œä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å½“å‰ 27017 ç«¯å£è¢«å“ªä¸ªè¿›ç¨‹å ç”¨ï¼Œå¦‚æœæ˜¯ MongoDB çš„è¿›ç¨‹ï¼Œåˆ™è¡¨ç¤ºå¯åŠ¨æˆåŠŸã€‚</p>
</blockquote>
<h3 id="-mongodb-">æ·»åŠ  MongoDB ç”¨æˆ·</h3>
<p>ç™»å½•æœ¬åœ° MongoDB æœåŠ¡ï¼š</p>
<pre><code>mongo
</code></pre><p>ç™»å½•åï¼Œåˆ›å»ºä¸€ä¸ªç”¨æˆ· <code>weapp</code> <sup>[<a href="#stage-5-step-3-why-weapp">?</a>]</sup>ï¼š</p>
<pre><code>use weapp;
db.createUser({ user: 'weapp', pwd: 'weapp-dev', roles: ['dbAdmin', 'readWrite']});
</code></pre><p>åˆ›å»ºå®Œæˆåï¼Œä½¿ç”¨ <code>exit</code> é€€å‡ºå‘½ä»¤è¡Œå·¥å…·ã€‚</p>
<p><a id="stage-5-step-3-why-weapp"></a></p>
<blockquote>
<p>åˆ›å»ºçš„ç”¨æˆ·å’Œå¯†ç å°†ç”¨äºä¸‹ä¸€æ­¥ä¸­è¿æ¥æ•°æ®åº“æ—¶ä½¿ç”¨ï¼Œå¦‚æœä½¿ç”¨ä¸åŒçš„ç”¨æˆ·æˆ–å¯†ç ï¼Œæ³¨æ„è¦ä¿å­˜å¥½</p>
</blockquote>
<h3 id="-node-">å®‰è£… Node æ¨¡å—</h3>
<p>å®ç°å°ç¨‹åºçš„ä¼šè¯åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… <sup>[<a href="#stage-5-step-4-1">connect-mongo</a>]</sup> å’Œ <sup>[<a href="#stage-5-step-4-2">wafer-node-session</a>]</sup></p>
<pre><code>cd /data/release/weapp
npm install connect-mongo wafer-node-session --save
</code></pre><p><a id="stage-5-step-4-1"></a></p>
<blockquote>
<p>[connect-mongo][<a target="_blank" href="https://github.com/jdesboeufs/connect-mongo" title="null">https://github.com/jdesboeufs/connect-mongo</a>] æ¨¡å—é€šè¿‡è¿æ¥åˆ° MongoDB ä¸ºä¼šè¯æä¾›å­˜å‚¨</p>
</blockquote>
<p><a id="stage-5-step-4-2"></a></p>
<blockquote>
<p>[wafer-node-session][<a target="_blank" href="https://github.com/tencentyun/wafer-node-session" title="null">https://github.com/tencentyun/wafer-node-session</a>] æ˜¯ç”±è…¾è®¯äº‘æä¾›çš„ç‹¬ç«‹å°ç¨‹åºä¼šè¯ç®¡ç†ä¸­é—´ä»¶</p>
</blockquote>
<h3 id="-">å®ç°å°ç¨‹åºä¼šè¯</h3>
<p>åœ¨å·¥ä½œç›®å½•<em>åˆ›å»ºé…ç½®æ–‡ä»¶ config.js</em>ï¼Œç”¨äºä¿å­˜æˆ‘ä»¬æœåŠ¡æ‰€ç”¨çš„é…ç½®<sup>[<a href="#stage-5-step-5-2">?</a>]</sup>ï¼Œå¯å‚è€ƒä¸‹é¢çš„å®ç°(æ³¨ï¼šè¯·å°†å‚è€ƒé…ç½®æ–‡ä»¶ä¸­çš„ YORU_APP_ID å’Œ YOUR_APP_SECRET æ›¿æ¢ä¸ºä½ ç”³è¯·çš„å°ç¨‹åºå¯¹åº”çš„ AppID å’Œ AppSecret)ï¼š</p>
<h5 id="-data-release-weapp-config-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/config.js</h5>
<pre><code class="lang-js">module.exports = { 
    serverPort: '8765', 

    // å°ç¨‹åº appId å’Œ appSecret 
    // è¯·åˆ° https://mp.weixin.qq.com è·å– AppID å’Œ AppSecret
    appId: 'YORU_APP_ID', 
    appSecret: 'YOUR_APP_SECRET', 

    // mongodb è¿æ¥é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨æ›´å¤æ‚çš„ç”¨æˆ·åå¯†ç 
    mongoHost: '127.0.0.1', 
    mongoPort: '27017', 
    mongoUser: 'weapp', 
    mongoPass: 'weapp-dev', 
    mongoDb: 'weapp'
};
</code></pre>
<p><em>ç¼–è¾‘ app.js</em>ï¼Œæ·»åŠ ä¼šè¯å®ç°é€»è¾‘ï¼Œå¯å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p>
<h5 id="-data-release-weapp-app-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/app.js</h5>
<pre><code class="lang-js">// å¼•ç”¨ express æ¥æ”¯æŒ HTTP Server çš„å®ç°
const express = require('express');
// å¼•ç”¨ wafer-session æ”¯æŒå°ç¨‹åºä¼šè¯
const waferSession = require('wafer-node-session'); 
// ä½¿ç”¨ MongoDB ä½œä¸ºä¼šè¯çš„å­˜å‚¨
const MongoStore = require('connect-mongo')(waferSession); 
// å¼•å…¥é…ç½®æ–‡ä»¶
const config = require('./config'); 

// åˆ›å»ºä¸€ä¸ª express å®ä¾‹
const app = express();

// æ·»åŠ ä¼šè¯ä¸­é—´ä»¶ï¼Œç™»å½•åœ°å€æ˜¯ /login
app.use(waferSession({ 
    appId: config.appId, 
    appSecret: config.appSecret, 
    loginPath: '/login',
    store: new MongoStore({ 
        url: `mongodb://${config.mongoUser}:${config.mongoPass}@${config.mongoHost}:${config.mongoPort}/${config.mongoDb}` 
    }) 
})); 

// åœ¨è·¯ç”± /me ä¸‹ï¼Œè¾“å‡ºä¼šè¯é‡ŒåŒ…å«çš„ç”¨æˆ·ä¿¡æ¯
app.use('/me', (request, response, next) =&gt; { 
    response.json(request.session ? request.session.userInfo : { noBody: true }); 
    if (request.session) {
        console.log(`Wafer session success with openId=${request.session.userInfo.openId}`);
    }
}); 

// å®ç°ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¯¹äºæœªå¤„ç†çš„è¯·æ±‚ï¼Œéƒ½è¾“å‡º "Response from express"
app.use((request, response, next) =&gt; {
    response.write('Response from express');
    response.end();
});

// ç›‘å¬ç«¯å£ï¼Œç­‰å¾…è¿æ¥
app.listen(config.serverPort);

// è¾“å‡ºæœåŠ¡å™¨å¯åŠ¨æ—¥å¿—
console.log(`Server listening at http://127.0.0.1:${config.serverPort}`);
</code></pre>
<p>æºç ç¼–å†™å®Œæˆåï¼Œé‡å¯æœåŠ¡ï¼š</p>
<pre><code>pm2 restart app
</code></pre><p>é‡å¯åï¼Œä½¿ç”¨é…å¥—çš„å°ç¨‹åºå®Œæˆä¼šè¯æµ‹è¯•ï¼šæ‰“å¼€é…å¥—å°ç¨‹åº - ç‚¹å‡» <code>å®éªŒäºŒï¼šä¼šè¯</code> - <code>è·å–ä¼šè¯</code>ï¼Œå¦‚æœæ‚¨èƒ½çœ‹åˆ°æ‚¨çš„å¾®ä¿¡å¤´åƒï¼Œé‚£å°±è¡¨ç¤ºä¼šè¯å·²ç»æˆåŠŸè·å–äº†ã€‚</p>
<p><a id="stage-5-step-5-2"></a></p>
<blockquote>
<p>éšç€æœåŠ¡å˜å¾—å¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé…ç½®é›†ä¸­èµ·æ¥æ–¹ä¾¿ç®¡ç†ï¼Œæ¯”å¦‚ç›®å‰æˆ‘ä»¬éœ€è¦ä¿å­˜ï¼šæœåŠ¡å™¨è¿è¡Œç«¯å£ã€å°ç¨‹åºé…ç½®ã€MongoDB è¿æ¥é…ç½®</p>
</blockquote>
<h2 id="websocket-">WebSocket æœåŠ¡</h2>
<blockquote>
<p>ä»»åŠ¡æ—¶é—´ï¼š45min ~ 90min</p>
</blockquote>
<h3 id="-node-">å®‰è£… Node æ¨¡å—</h3>
<p>æœ¬å®éªŒä½¿ç”¨ <code>ws</code> æ¨¡å—æ¥åœ¨æœåŠ¡å™¨ä¸Šæ”¯æŒ WebSocket åè®®ï¼Œä¸‹é¢ä½¿ç”¨ NPM æ¥å®‰è£…ï¼š</p>
<pre><code>cd /data/release/weapp
npm install ws --save
</code></pre><h3 id="-websocket-">å®ç° WebSocket æœåŠ¡å™¨</h3>
<p><em>åˆ›å»º websocket.js</em>ï¼Œå®ç° WebSocket æœåŠ¡ï¼Œå¯å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p>
<h5 id="-data-release-weapp-websocket-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/websocket.js</h5>
<pre><code class="lang-js">// å¼•å…¥ ws æ”¯æŒ WebSocket çš„å®ç°
const ws = require('ws');

// å¯¼å‡ºå¤„ç†æ–¹æ³•
exports.listen = listen;

/**
 * åœ¨ HTTP Server ä¸Šå¤„ç† WebSocket è¯·æ±‚
 * @param {http.Server} server
 * @param {wafer.SessionMiddleware} sessionMiddleware
 */
function listen(server, sessionMiddleware) {
    // ä½¿ç”¨ HTTP Server åˆ›å»º WebSocket æœåŠ¡ï¼Œä½¿ç”¨ path å‚æ•°æŒ‡å®šéœ€è¦å‡çº§ä¸º WebSocket çš„è·¯å¾„
    const wss = new ws.Server({ server, path: '/ws' });

    // ç›‘å¬ WebSocket è¿æ¥å»ºç«‹
    wss.on('connection', (ws,request) =&gt; {// è¦å‡çº§åˆ° WebSocket åè®®çš„ HTTP è¿æ¥

        // è¢«å‡çº§åˆ° WebSocket çš„è¯·æ±‚ä¸ä¼šè¢« express å¤„ç†ï¼Œ
        // éœ€è¦ä½¿ç”¨ä¼šè¯ä¸­é—´èŠ‚è·å–ä¼šè¯
        sessionMiddleware(request, null, () =&gt; {
            const session = request.session;
            if (!session) {
                // æ²¡æœ‰è·å–åˆ°ä¼šè¯ï¼Œå¼ºåˆ¶æ–­å¼€ WebSocket è¿æ¥
                ws.send(JSON.stringify(request.sessionError) || "No session avaliable");
                ws.close();
                return;
            }
            // ä¿ç•™è¿™ä¸ªæ—¥å¿—çš„è¾“å‡ºå¯è®©å®éªŒå®¤èƒ½æ£€æŸ¥åˆ°å½“å‰æ­¥éª¤æ˜¯å¦å®Œæˆ
            console.log(`WebSocket client connected with openId=${session.userInfo.openId}`);
            serveMessage(ws, session.userInfo);
        });
    });

    // ç›‘å¬ WebSocket æœåŠ¡çš„é”™è¯¯
    wss.on('error', (err) =&gt; {
        console.log(err);
    });
}

/**
 * è¿›è¡Œç®€å•çš„ WebSocket æœåŠ¡ï¼Œå¯¹äºå®¢æˆ·ç«¯å‘æ¥çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å›å¤å›å»
 */
function serveMessage(ws, userInfo) {
    // ç›‘å¬å®¢æˆ·ç«¯å‘æ¥çš„æ¶ˆæ¯
    ws.on('message', (message) =&gt; {
        console.log(`WebSocket received: ${message}`);
        ws.send(`Server: Received(${message})`);
    });

    // ç›‘å¬å…³é—­äº‹ä»¶
    ws.on('close', (code, message) =&gt; {
        console.log(`WebSocket client closed (code: ${code}, message: ${message || 'none'})`);
    });

    // è¿æ¥åé©¬ä¸Šå‘é€ hello æ¶ˆæ¯ç»™ä¼šè¯å¯¹åº”çš„ç”¨æˆ·
    ws.send(`Server: æ­å–œï¼Œ${userInfo.nickName}`);
}
</code></pre>
<p><em>ç¼–è¾‘ app.js</em>ï¼Œè°ƒç”¨ WebSocket æœåŠ¡ï¼Œå¯å‚è€ƒä¸‹é¢ä»£ç ï¼š</p>
<h5 id="-data-release-weapp-app-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/app.js</h5>
<pre><code class="lang-js">// HTTP æ¨¡å—åŒæ—¶æ”¯æŒ Express å’Œ WebSocket
const http = require('http'); 
// å¼•ç”¨ express æ¥æ”¯æŒ HTTP Server çš„å®ç°
const express = require('express');
// å¼•ç”¨ wafer-session æ”¯æŒå°ç¨‹åºä¼šè¯
const waferSession = require('wafer-node-session'); 
// ä½¿ç”¨ MongoDB ä½œä¸ºä¼šè¯çš„å­˜å‚¨
const MongoStore = require('connect-mongo')(waferSession); 
// å¼•å…¥é…ç½®æ–‡ä»¶
const config = require('./config'); 
// å¼•å…¥ WebSocket æœåŠ¡å®ç°
const websocket = require('./websocket');

// åˆ›å»ºä¸€ä¸ª express å®ä¾‹
const app = express();

// ç‹¬ç«‹å‡ºä¼šè¯ä¸­é—´ä»¶ç»™ express å’Œ ws ä½¿ç”¨
const sessionMiddleware = waferSession({
    appId: config.appId,
    appSecret: config.appSecret,
    loginPath: '/login',
    store: new MongoStore({
        url: `mongodb://${config.mongoUser}:${config.mongoPass}@${config.mongoHost}:${config.mongoPort}/${config.mongoDb}`
    })
});
app.use(sessionMiddleware);

// åœ¨è·¯ç”± /me ä¸‹ï¼Œè¾“å‡ºä¼šè¯é‡ŒåŒ…å«çš„ç”¨æˆ·ä¿¡æ¯
app.use('/me', (request, response, next) =&gt; { 
    response.json(request.session ? request.session.userInfo : { noBody: true }); 
    if (request.session) {
        console.log(`Wafer session success with openId=${request.session.userInfo.openId}`);
    }
}); 

// å®ç°ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¯¹äºæœªå¤„ç†çš„è¯·æ±‚ï¼Œéƒ½è¾“å‡º "Response from express"
app.use((request, response, next) =&gt; {
    response.write('Response from express');
    response.end();
});

// åˆ›å»º HTTP Server è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ express ç›‘å¬
const server = http.createServer(app);

// è®© WebSocket æœåŠ¡åœ¨åˆ›å»ºçš„ HTTP æœåŠ¡å™¨ä¸Šç›‘å¬
websocket.listen(server, sessionMiddleware);

// å¯åŠ¨ HTTP æœåŠ¡
server.listen(config.serverPort);

// è¾“å‡ºæœåŠ¡å™¨å¯åŠ¨æ—¥å¿—
console.log(`Server listening at http://127.0.0.1:${config.serverPort}`);
</code></pre>
<p>ä¿®æ”¹å®Œæˆåï¼ŒæŒ‰ <code>Ctrl + S</code> ä¿å­˜æ–‡ä»¶ï¼Œå¹¶é‡å¯æœåŠ¡ï¼š</p>
<pre><code>pm2 restart app
</code></pre><h3 id="-nginx-">æ›´æ–° Nginx ä»£ç†</h3>
<p><em>ç¼–è¾‘ Nginx é…ç½® ssl.conf</em>ï¼Œæ·»åŠ  WebSocket æ”¯æŒï¼Œå¯å‚è€ƒä¸‹é¢çš„é…ç½®(æ³¨ï¼šè¯·å°†å‚è€ƒé…ç½®æ–‡ä»¶ä¸­çš„ www.example.com æ›¿æ¢ä¸ºå‰é¢æ­¥éª¤ç”³è¯·çš„åŸŸåï¼Œå°† 1_www.example.com.crt å’Œ 2_www.example.com.key æ›¿æ¢ä¸ºå‰é¢æ­¥éª¤ç”³è¯·å¹¶ä¸Šä¼ çš„ SSL è¯ä¹¦çš„åç§°)ï¼š</p>
<h5 id="-etc-nginx-conf-d-ssl-conf">ç¤ºä¾‹ä»£ç ï¼š/etc/nginx/conf.d/ssl.conf</h5>
<pre><code class="lang-conf"># WebSocket é…ç½®
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
        listen 443;
        server_name www.example.com; # æ”¹ä¸ºç»‘å®šè¯ä¹¦çš„åŸŸå
        # ssl é…ç½®
        ssl on;
        ssl_certificate 1_www.example.com.crt; # æ”¹ä¸ºè‡ªå·±ç”³è¯·å¾—åˆ°çš„ crt æ–‡ä»¶çš„åç§°
        ssl_certificate_key 2_www.example.com.key; # æ”¹ä¸ºè‡ªå·±ç”³è¯·å¾—åˆ°çš„ key æ–‡ä»¶çš„åç§°
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;

        # WebSocket é…ç½®
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        location / {
            proxy_pass http://127.0.0.1:8765;
        }
    }
</code></pre>
<p>é…ç½®å®Œæˆåï¼ŒæŒ‰ <code>Ctrl + S</code> ä¿å­˜ï¼Œå¹¶ä¸”é€šçŸ¥ Nginx è¿›ç¨‹é‡æ–°åŠ è½½é…ç½®ï¼š</p>
<pre><code>nginx -s reload
</code></pre><h3 id="-websocket">æµ‹è¯• WebSocket</h3>
<p>æ‰“å¼€é…å¥—çš„å°ç¨‹åºï¼Œç‚¹å‡» <code>å®éªŒä¸‰ï¼šWebSocket</code>ã€‚è¿›å…¥æµ‹è¯•é¡µé¢åï¼Œç‚¹å‡» <code>è¿æ¥</code> æŒ‰é’®ï¼Œå¦‚æœå‡ºç°è¿æ¥æˆåŠŸçš„æç¤ºï¼Œè¡¨ç¤º WebSocket æœåŠ¡å·²ç»æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥æ”¶å‘æ¶ˆæ¯ã€‚</p>
<h2 id="-">å‰ªåˆ€çŸ³å¤´å¸ƒå°æ¸¸æˆ</h2>
<blockquote>
<p>ä»»åŠ¡æ—¶é—´ï¼š45min ~ 90min</p>
</blockquote>
<h3 id="-">å®ç°æ¸¸æˆæˆ¿é—´é€»è¾‘</h3>
<p>åˆ›å»º /data/release/weapp/game ç›®å½•ç”¨äºå­˜æ”¾å‰ªåˆ€çŸ³å¤´å¸ƒå°æ¸¸æˆçš„ä»£ç </p>
<pre><code>mkdir -p /data/release/weapp/game
</code></pre><p>æ·»åŠ  <em>game/Room.js</em> å®ç°æ¸¸æˆæˆ¿é—´é€»è¾‘<sup>[<a href="#stage-7-step-1-what">?</a>]</sup>ï¼Œå¯å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p>
<h5 id="-data-release-weapp-game-room-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/game/Room.js</h5>
<pre><code class="lang-javascript">
/**
enum GameChoice {
    // å‰ªåˆ€
    Scissors = 1,
    // çŸ³å¤´
    Rock = 2,
    // å¸ƒ
    Paper = 3
}
*/
function judge(choice1, choice2) {
    // å’Œå±€
    if (choice1 == choice2) return 0;
    // Player 1 æ²¡å‡ºï¼ŒPlayer 2 èƒœå‡º
    if (!choice1) return 1;
    // Player 2 æ²¡å‡ºï¼ŒPlayer 1 èƒœå‡º
    if (!choice2) return -1;
    // éƒ½å‡ºäº†å°±è¿™ä¹ˆç®—
    return (choice1 - choice2 + 3) % 3 == 1 ? -1 : 1;
}

/** @type {Room[]} */
const globalRoomList = [];

// æ¯ä¸ªæˆ¿é—´æœ€å¤šä¸¤äºº
const MAX_ROOT_MEMBER = 2;

// æ¸¸æˆæ—¶é—´ï¼Œå•ä½ç§’
const GAME_TIME = 3;

let nextRoomId = 0;

/** è¡¨ç¤ºä¸€ä¸ªæˆ¿é—´ */
module.exports = class Room {

    /** è·å–æ‰€æœ‰æˆ¿é—´ */
    static all() {
        return globalRoomList.slice();
    }

    /** è·å–æœ‰åº§ä½çš„æˆ¿é—´ */
    static findRoomWithSeat() {
        return globalRoomList.find(x =&gt; !x.isFull());
    }

    /** åˆ›å»ºæ–°æˆ¿é—´ */
    static create() {
        const room = new Room();
        globalRoomList.unshift(room);
        return room;
    }

    constructor() {
        this.id = `room${nextRoomId++}`;
        this.players = [];
    }

    /** æ·»åŠ ç©å®¶ */
    addPlayer(player) {
        const { uid, uname } = player.user;
        console.log(`Player ${uid}(${uname}) enter ${this.id}`);
        this.players.push(player);
        if (this.isFull()) {
            this.startGame();
        }
    }

    /** åˆ é™¤ç©å®¶ */
    removePlayer(player) {
        const { uid, uname } = player.user;
        console.log(`Player ${uid}(${uname}) leave ${this.id}`);
        const playerIndex = this.players.indexOf(player);
        if (playerIndex != -1) {
            this.players.splice(playerIndex, 1);
        }
        if (this.players.length === 0) {
            console.log(`Room ${this.id} is empty now`);
            const roomIndex = globalRoomList.indexOf(this);
            if (roomIndex &gt; -1) {
                globalRoomList.splice(roomIndex, 1);
            }
        }
    }

    /** ç©å®¶å·²æ»¡ */
    isFull() {
        return this.players.length == MAX_ROOT_MEMBER;
    }

    /** å¼€å§‹æ¸¸æˆ */
    startGame() {
        // ä¿ç•™è¿™è¡Œæ—¥å¿—è¾“å‡ºå¯ä»¥è®©å®éªŒå®¤æ£€æŸ¥åˆ°å®éªŒçš„å®Œæˆæƒ…å†µ
        console.log('game started!');

        // å½“å±€ç§¯åˆ†æ¸…é›¶
        this.players.forEach(player =&gt; player.gameData.roundScore = 0);

        // é›†åˆç©å®¶ç”¨æˆ·å’Œæ¸¸æˆæ•°æ®
        const players = this.players.map(player =&gt; Object.assign({}, player.user, player.gameData));

        // é€šçŸ¥æ‰€æœ‰ç©å®¶å¼€å§‹
        for (let player of this.players) {
            player.send('start', {
                gameTime: GAME_TIME,
                players
            });
        }

        // è®¡æ—¶ç»“æŸ
        setTimeout(() =&gt; this.finishGame(), GAME_TIME * 1000);
    }

    /** ç»“æŸæ¸¸æˆ */
    finishGame() {
        const players = this.players;

        // ä¸¤ä¸¤å¯¹æ¯”ç®—åˆ†
        for (let i = 0; i &lt; MAX_ROOT_MEMBER; i++) {
            let p1 = players[i];
            if (!p1) break;
            for (let j = i + 1; j &lt; MAX_ROOT_MEMBER; j++) {
                let p2 = players[j];
                const result = judge(p1.gameData.choice, p2.gameData.choice);
                p1.gameData.roundScore -= result;
                p2.gameData.roundScore += result;
            }
        }
        // è®¡ç®—è¿èƒœå¥–åŠ±
        for (let player of players) {
            const gameData = player.gameData;
            // èƒœå±€ç§¯åˆ†
            if (gameData.roundScore &gt; 0) {
                gameData.winStreak++;
                gameData.roundScore *= gameData.winStreak;
            }
            // è´¥å±€æ¸…é›¶
            else if (gameData.roundScore &lt; 0) {
                gameData.roundScore = 0;
                gameData.winStreak = 0;
            }
            // ç´¯ç§¯æ€»åˆ†
            gameData.totalScore += gameData.roundScore;
        }
        // è®¡ç®—ç»“æœ
        const result = players.map(player =&gt; {
            const { uid } = player.user;
            const { roundScore, totalScore, winStreak, choice } = player.gameData;
            return { uid, roundScore, totalScore, winStreak, choice };
        });
        // é€šçŸ¥æ‰€æœ‰ç©å®¶æ¸¸æˆç»“æœ
        for (let player of players) {
            player.send('result', { result });
        }
    }
}
</code></pre>
<p><a id="stage-7-step-1-what"></a></p>
<blockquote>
<p>å¤„ç†æ¸¸æˆå¼€å§‹ã€è®¡ç®—ç»“æœã€ç§¯åˆ†ç­‰é€»è¾‘</p>
</blockquote>
<h3 id="-">å®ç°ç©å®¶é€»è¾‘</h3>
<p>æ·»åŠ  <em>game/Player.js</em> å®ç°ç©å®¶é€»è¾‘<sup>[<a href="#stage-7-step-2-what">?</a>]</sup>ï¼Œå¯å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p>
<h5 id="-data-release-weapp-game-player-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/game/Player.js</h5>
<pre><code class="lang-js">const Room = require("./Room");

/**
 * è¡¨ç¤ºä¸€ä¸ªç©å®¶ï¼Œå¤„ç†ç©å®¶çš„å…¬å…±æ¸¸æˆé€»è¾‘ï¼Œæ¶ˆæ¯å¤„ç†éƒ¨åˆ†éœ€è¦å…·ä½“çš„ç©å®¶å®ç°ï¼ˆè¯·å‚è€ƒ ComputerPlayer å’Œ HumanPlayerï¼‰
 */
module.exports = class Player {
    constructor(user) {
        this.id = user.uid;
        this.user = user;
        this.room = null;
        this.gameData = {
            // å½“å‰çš„é€‰æ‹©ï¼ˆå‰ªåˆ€/çŸ³å¤´/å¸ƒï¼‰
            choice: null,
            // å±€ç§¯åˆ†
            roundScore: 0,
            // æ€»ç§¯åˆ†
            totalScore: 0,
            // è¿èƒœæ¬¡æ•°
            winStreak: 0
        };
    }

    /**
     * ä¸Šçº¿å½“å‰ç©å®¶ï¼Œå¹¶ä¸”å¼‚æ­¥è¿”å›ç»™ç©å®¶åˆ†é…çš„æˆ¿é—´
     */
    online(room) {
        // å¤„ç†ç©å®¶ 'join' æ¶ˆæ¯
        // ä¸ºç©å®¶å¯»æ‰¾ä¸€ä¸ªå¯ç”¨çš„æˆ¿é—´ï¼Œå¹¶ä¸”å¼‚æ­¥è¿”å›
        this.receive('join', () =&gt; {
            if (this.room) {
                this.room.removePlayer(this);
            }
            room = this.room = room || Room.findRoomWithSeat() || Room.create();
            room.addPlayer(this);
        });

        // å¤„ç†ç©å®¶ 'choise' æ¶ˆæ¯
        // éœ€è¦è®°å½•ç©å®¶å½“å‰çš„é€‰æ‹©ï¼Œå¹¶ä¸”é€šçŸ¥åˆ°æˆ¿é—´é‡Œçš„å…¶å®ƒç©å®¶
        this.receive('choice', ({ choice }) =&gt; {
            this.gameData.choice = choice;
            this.broadcast('movement', {
                uid: this.user.uid,
                movement: "choice"
            });
        });

        // å¤„ç†ç©å®¶ 'leave' æ¶ˆæ¯
        // è®©ç©å®¶ä¸‹çº¿
        this.receive('leave', () =&gt; this.offline);
    }

    /**
     * ä¸‹çº¿å½“å‰ç©å®¶ï¼Œä»æˆ¿é—´ç¦»å¼€
     */
    offline() {
        if (this.room) {
            this.room.removePlayer(this);
            this.room = null;
        }
        this.user = null;
        this.gameData = null;
    }

    /**
     * å‘é€æŒ‡å®šæ¶ˆæ¯ç»™å½“å‰ç©å®¶ï¼Œéœ€è¦å…·ä½“å­ç±»å®ç°
     * @abstract
     * @param {string} message æ¶ˆæ¯ç±»å‹
     * @param {*} data æ¶ˆæ¯æ•°æ®
     */
    send(message, data) {
        throw new Error('Not implement: AbstractPlayer.send()');
    }

    /**
     * å¤„ç†ç©å®¶å‘é€çš„æ¶ˆæ¯ï¼Œéœ€è¦å…·ä½“å­ç±»å®ç°
     * @abstract
     * @param {string} message æ¶ˆæ¯ç±»å‹
     * @param {Function} handler
     */
    receive(message, handler) {
        throw new Error('Not implement: AbstractPlayer.receive()');
    }

    /**
     * ç»™ç©å®¶æ‰€åœ¨æˆ¿é—´é‡Œçš„å…¶å®ƒç©å®¶å‘é€æ¶ˆæ¯
     * @param {string} message æ¶ˆæ¯ç±»å‹
     * @param {any} data æ¶ˆæ¯æ•°æ®
     */
    broadcast(message, data) {
        if (!this.room) return;
        this.others().forEach(neighbor =&gt; neighbor.send(message, data));
    }

    /**
     * è·å¾—ç©å®¶æ‰€åœ¨æˆ¿é—´é‡Œçš„å…¶ä»–ç©å®¶
     */
    others() {
        return this.room.players.filter(player =&gt; player != this);
    }
}
</code></pre>
<p><a id="stage-7-step-2-what"></a></p>
<blockquote>
<p>å¤„ç†ç©å®¶åŠ å…¥æ¸¸æˆã€é€‰æ‹©å‡ºæ‹³ã€é€šçŸ¥å…¶ä»–ç©å®¶ç­‰é€»è¾‘</p>
</blockquote>
<h3 id="-">å®ç°ç”µè„‘ç©å®¶</h3>
<p>åœ¨å®ç°äººç±»ç©å®¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ›å»º <em>ComputerPlayer.js</em> æ¥å®ç°ç”µè„‘ç©å®¶<sup>[<a href="#stage-7-step-3-why">?</a>]</sup></p>
<h5 id="-data-release-weapp-game-computerplayer-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/game/ComputerPlayer.js</h5>
<pre><code class="lang-javascript">const EventEmitter = require('events');
const Player = require('./Player');

let nextComputerId = 0;

/**
 * æœºå™¨äººç©å®¶å®ç°ï¼Œä½¿ç”¨ EventEmitter æ¥æ”¶å’Œå‘é€æ¶ˆæ¯
 */
module.exports = class ComputerPlayer extends Player {
    constructor() {
        const computerId = `robot-${++nextComputerId}`;
        super({
            uid: computerId,
            uname: computerId,
            uavatar: 'http://www.scoutiegirl.com/wp-content/uploads/2015/06/Blue-Robot.png'
        });
        this.emitter = new EventEmitter();
    }

    /**
     * æ¨¡æ‹Ÿç©å®¶è¡Œä¸º
     */
    simulate() {
        this.receive('start', () =&gt; this.play());
        this.receive('result', () =&gt; this.stop());
        this.send('join');
    }

    /**
     * æ¸¸æˆå¼€å§‹åï¼Œéšæœºæ—¶é—´åéšæœºé€‰æ‹©
     */
    play() {
        this.playing = true;
        const randomTime = () =&gt; Math.floor(100 + Math.random() * 2000);
        const randomChoice = () =&gt; {
            if (!this.playing) return;
            this.send("choice", {
                choice: Math.floor(Math.random() * 10000) % 3 + 1
            });
            setTimeout(randomChoice, randomTime());
        }
        setTimeout(randomChoice, 10);
    }

    /**
     * æ¸¸æˆç»“æŸåï¼Œæ ‡è®°èµ·æ¥ï¼Œé˜»æ­¢ç»§ç»­éšæœºé€‰æ‹©
     */
    stop() {
        this.playing = false;
    }

    /**
     * å‘é€æ¶ˆæ¯ç»™å½“å‰ç©å®¶ï¼Œç›´æ¥è½¬å‘åˆ° emitter
     */
    send(message, data) {
        this.emitter.emit(message, data);
    }

    /**
     * ä»å½“å‰çš„ emitter å¤„ç†æ¶ˆæ¯
     */
    receive(message, handle) {
        this.emitter.on(message, handle);
    }
}
</code></pre>
<p><a id="stage-7-step-3-why"></a></p>
<blockquote>
<p>æµ‹è¯•æ¸¸æˆé€»è¾‘çš„æ—¶å€™ï¼Œå¯èƒ½æ²¡æœ‰å…¶å®ƒäººå¯ä»¥ä¸€èµ·å‚ä¸ï¼Œå®ç°ä¸€ä¸ªç”µè„‘ç©å®¶æ˜¯ä¸é”™çš„é€‰æ‹©</p>
</blockquote>
<h3 id="-">å®ç°äººç±»ç©å®¶</h3>
<p>äººç±»ç©å®¶é€šè¿‡ WebSocket ä¿¡é“æ¥å®ç°ç©å®¶çš„è¾“å…¥è¾“å‡º<sup>[<a href="#stage-7-step-4-what">?</a>]</sup>ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ  <em>game/Tunnel.js</em> å’Œ <em>game/HumanPlayer.js</em> æ¥å®ç°äººç±»ç©å®¶é€»è¾‘ï¼Œå¯å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p>
<h5 id="-data-release-weapp-game-tunnel-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/game/Tunnel.js</h5>
<pre><code class="lang-js">const EventEmitter = require('events');

/**
 * å°è£… WebSocket ä¿¡é“
 */
module.exports = class Tunnel {
    constructor(ws) {
        this.emitter = new EventEmitter();
        this.ws = ws;
        ws.on('message', packet =&gt; {
            try {
                // çº¦å®šæ¯ä¸ªæ•°æ®åŒ…æ ¼å¼ï¼š{ message: 'type', data: any }
                const { message, data } = JSON.parse(packet);
                this.emitter.emit(message, data);
            } catch (err) {
                console.log('unknown packet: ' + packet);
            }
        });
    }

    on(message, handle) {
        this.emitter.on(message, handle);
    }

    emit(message, data) {
        this.ws.send(JSON.stringify({ message, data }));
    }
}
</code></pre>
<h5 id="-data-release-weapp-game-humanplayer-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/game/HumanPlayer.js</h5>
<pre><code class="lang-js">const co = require('co');
const Player = require('./Player');
const ComputerPlayer = require('./ComputerPlayer');
const Tunnel = require('./Tunnel');

/**
 * äººç±»ç©å®¶å®ç°ï¼Œé€šè¿‡ WebSocket ä¿¡é“æ¥æ”¶å’Œå‘é€æ¶ˆæ¯
 */
module.exports = class HumanPlayer extends Player {
    constructor(user, ws) {
        super(user);
        this.ws = ws;
        this.tunnel = new Tunnel(ws);
        this.send('id', user);
    }

    /**
     * äººç±»ç©å®¶ä¸Šçº¿åï¼Œè¿˜éœ€è¦ç›‘å¬ä¿¡é“å…³é—­ï¼Œè®©ç©å®¶ä¸‹çº¿
     */
    online(room) {
        super.online(room);
        this.ws.on('close', () =&gt; this.offline());

        // äººç±»ç©å®¶è¯·æ±‚ç”µè„‘ç©å®¶
        this.receive('requestComputer', () =&gt; {
            const room = this.room;
            while(room &amp;&amp; !room.isFull()) {
                const computer = new ComputerPlayer();
                computer.online(room);
                computer.simulate();
            }
        });
    }

    /**
     * ä¸‹çº¿åå…³é—­ä¿¡é“
     */
    offline() {
        super.offline();
        if (this.ws &amp;&amp; this.ws.readyState == this.ws.OPEN) {
            this.ws.close();
        }
        this.ws = null;
        this.tunnel = null;
        if (this.room) {
            // æ¸…ç†æˆ¿é—´é‡Œé¢çš„ç”µè„‘ç©å®¶
            for (let player of this.room.players) {
                if (player instanceof ComputerPlayer) {
                    this.room.removePlayer(player);
                }
            }
            this.room = null;
        }
    }

    /**
     * é€šè¿‡ WebSocket ä¿¡é“å‘é€æ¶ˆæ¯ç»™ç©å®¶
     */
    send(message, data) {
        this.tunnel.emit(message, data);
    }

    /**
     * ä» WebSocket ä¿¡é“æ¥æ”¶ç©å®¶çš„æ¶ˆæ¯
     */
    receive(message, callback) {
        this.tunnel.on(message, callback);
    }
}
</code></pre>
<p><a id="stage-7-step-4-what"></a></p>
<blockquote>
<p>äººç±»ç©å®¶å’Œç”µè„‘ç©å®¶çš„é€»è¾‘æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯ IO ä¸åŒï¼Œäººç±»ç©å®¶ä½¿ç”¨ä¹‹å‰å®ç°çš„ WebSocket æœåŠ¡è¿›è¡Œè¾“å…¥è¾“å‡ºï¼Œè€Œç”µè„‘ç©å®¶ç›´æ¥ä½¿ç”¨ EventEmiter å¤„ç†</p>
</blockquote>
<h3 id="-">æ·»åŠ æ¸¸æˆæœåŠ¡å…¥å£</h3>
<p>æ¸¸æˆçš„å®ç°å·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥ï¼Œç¼–è¾‘ <em>websocket.js</em> æ·»åŠ æœåŠ¡å…¥å£ï¼Œå¯å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p>
<h5 id="-data-release-weapp-websocket-js">ç¤ºä¾‹ä»£ç ï¼š/data/release/weapp/websocket.js</h5>
<pre><code class="lang-js">// å¼•å…¥ url æ¨¡å—ç”¨äºè§£æ URL
const url = require('url');
// å¼•å…¥ ws æ”¯æŒ WebSocket çš„å®ç°
const ws = require('ws');
// å¼•å…¥äººç±»ç©å®¶
const HumanPlayer = require('./game/HumanPlayer');

// å¯¼å‡ºå¤„ç†æ–¹æ³•
exports.listen = listen;

/**
 * åœ¨ HTTP Server ä¸Šå¤„ç† WebSocket è¯·æ±‚
 * @param {http.Server} server
 * @param {wafer.SessionMiddleware} sessionMiddleware
 */
function listen(server, sessionMiddleware) {
    // ä½¿ç”¨ HTTP Server åˆ›å»º WebSocket æœåŠ¡ï¼Œä½¿ç”¨ path å‚æ•°æŒ‡å®šéœ€è¦å‡çº§ä¸º WebSocket çš„è·¯å¾„
    const wss = new ws.Server({ server });

    // åŒæ—¶æ”¯æŒ /ws å’Œ /game çš„ WebSocket è¿æ¥è¯·æ±‚ 
    wss.shouldHandle = (request) =&gt; { 
        const path = url.parse(request.url).pathname; 
        request.path = path; 
        return ['/ws', '/game'].indexOf(path) &gt; -1; 
    }; 

    // ç›‘å¬ WebSocket è¿æ¥å»ºç«‹
    wss.on('connection', (ws, request) =&gt; {
        // request: è¦å‡çº§åˆ° WebSocket åè®®çš„ HTTP è¿æ¥

        // è¢«å‡çº§åˆ° WebSocket çš„è¯·æ±‚ä¸ä¼šè¢« express å¤„ç†ï¼Œ
        // éœ€è¦ä½¿ç”¨ä¼šè¯ä¸­é—´èŠ‚è·å–ä¼šè¯
        sessionMiddleware(request, null, () =&gt; {
            const session = request.session;
            if (!session) {
                // æ²¡æœ‰è·å–åˆ°ä¼šè¯ï¼Œå¼ºåˆ¶æ–­å¼€ WebSocket è¿æ¥
                ws.send(JSON.stringify(request.sessionError) || "No session avaliable");
                ws.close();
                return;
            }
            console.log(`WebSocket client connected with openId=${session.userInfo.openId}`);

            // æ ¹æ®è¯·æ±‚çš„åœ°å€è¿›è¡Œä¸åŒå¤„ç† 
            switch (request.path) { 
                case '/ws': return serveMessage(ws, session.userInfo); 
                case '/game': return serveGame(ws, session.userInfo); 
                default: return ws.close();
            }
        });
    });

    // ç›‘å¬ WebSocket æœåŠ¡çš„é”™è¯¯
    wss.on('error', (err) =&gt; {
        console.log(err);
    });
}

/**
 * è¿›è¡Œç®€å•çš„ WebSocket æœåŠ¡ï¼Œå¯¹äºå®¢æˆ·ç«¯å‘æ¥çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å›å¤å›å»
 */
function serveMessage(ws, userInfo) {
    // ç›‘å¬å®¢æˆ·ç«¯å‘æ¥çš„æ¶ˆæ¯
    ws.on('message', (message) =&gt; {
        console.log(`WebSocket received: ${message}`);
        ws.send(`Server: Received(${message})`);
    });

    // ç›‘å¬å…³é—­äº‹ä»¶
    ws.on('close', (code, message) =&gt; {
        console.log(`WebSocket client closed (code: ${code}, message: ${message || 'none'})`);
    });

    // è¿æ¥åé©¬ä¸Šå‘é€ hello æ¶ˆæ¯ç»™ä¼šè¯å¯¹åº”çš„ç”¨æˆ·
    ws.send(`Server: æ­å–œï¼Œ${userInfo.nickName}`);
}

/**
 * ä½¿ç”¨ WebSocket è¿›è¡Œæ¸¸æˆæœåŠ¡
 */
function serveGame(ws, userInfo) {
    const user = { 
        uid: userInfo.openId, 
        uname: userInfo.nickName, 
        uavatar: userInfo.avatarUrl 
    }; 
    // åˆ›å»ºç©å®¶ 
    const player = new HumanPlayer(user, ws); 
    // ç©å®¶ä¸Šçº¿
    player.online();
}
</code></pre>
<h3 id="-co-">å®‰è£… co æ¨¡å—</h3>
<p>æˆ‘ä»¬çš„æºç ä¸­ä½¿ç”¨åˆ°äº† co è¿›è¡Œåç¨‹ç®¡ç†ï¼Œå¯åŠ¨æ¸¸æˆæœåŠ¡å‰ï¼Œéœ€è¦å…ˆå®‰è£…ï¼š</p>
<pre><code>cd /data/release/weapp
npm install co --save
</code></pre><h3 id="-">æµ‹è¯•æ¸¸æˆæœåŠ¡</h3>
<p>é‡å¯ Node æœåŠ¡ï¼š</p>
<pre><code>pm2 restart app
</code></pre><p>æ‰“å¼€é…å¥—çš„å°ç¨‹åºï¼Œç‚¹å‡» <code>å®éªŒå›› - å‰ªåˆ€çŸ³å¤´å¸ƒå°æ¸¸æˆ</code>ï¼Œç‚¹å‡» <code>å¼€å§‹</code> æŒ‰é’®è¿›è¡Œæ¸¸æˆã€‚</p>
<h3 id="-">å®Œæˆå®éªŒ</h3>
<p>æ­å–œï¼æ‚¨å·²ç»å®Œæˆäº†å°ç¨‹åºæœåŠ¡çš„å…¨éƒ¨å®éªŒå†…å®¹ï¼ä½ å¯ä»¥é€‰æ‹©ä¿ç•™å·²ç»è¿è¡Œçš„æœåŠ¡ï¼Œç»§ç»­è¿›è¡Œå°ç¨‹åºçš„å­¦ä¹ ç ”ç©¶ï¼Œå»ºè®®ç•™ç”¨æœºå™¨ã€‚</p>
</div>
</body></html>    ( > \ k ‚ ”  ¤ ° ±                           ¯‚